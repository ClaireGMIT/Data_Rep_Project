<!DOCTYPE html>

<html>

<head>
    <title> Index </title>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
            
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
                    integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    
    <style type="text/css">
	h1{
		color: purple; font-family: Arial; text-shadow: 1px 2px 0px #000000; font-weight: bold;
		}
	h2{
		color: black; font-family: Times; font-weight: bold;
		}
	body{
		background-color: #d5d3d3;
		padding: 30px;
	}
	.myClass{background-color:#b87db8; padding: 10px;}
    </style>
</head>

<body>
    <img src="images/Tablets7.jpg" width="200" align="center" alt="Pic1" title="PharmaBusiness Logo">
    

    <div id="create-update" style="display:none" >
        <h1> Create and Edit</h1>

        <table border="7" cellpadding="7" cellspacing="2" align="center" bgcolor="purple"   id="createUpdateForm">
    
            <tr align="center" height="50"> 
                <td width="150" bgcolor="grey"> Batch_No </td>
                <td width="150" bgcolor="white"><input type="text" name="Batch_No" id="idInput"></td>
            </tr>
            <tr align="center" height="50"> 
                <td width="150" bgcolor="grey"> API_Lot_No </td>
                <td width="150" bgcolor="white"><input type="text" name="API_Lot_No"></td>
            </tr>
            <tr align="center" height="50"> 
                <td width="150" bgcolor="grey"> API_Particle_Size </td>
                <td width="150" bgcolor="white"><input type="text" name="API_Particle_Size"></td>
            </tr>
            <tr align="center" height="50"> 
                <td width="150" bgcolor="grey"> Screen_Size </td>
                <td width="150" bgcolor="white"><input type="text" name="Screen_Size"></td>
            </tr>
            <tr align="center" height="50"> 
                <td width="150" bgcolor="grey"> Blend_Time </td>
                <td width="150" bgcolor="white"><input type="number" name="Blend_Time "></td>
            </tr>
            <tr align="center" height="50"> 
                <td width="150" bgcolor="grey"> Compressor </td>
                <td width="150" bgcolor="white"><input type="text" name="Compressor"></td>
            </tr>
            <tr align="center" height="50"> 
                <td width="150" bgcolor="grey"> Inlet_Temp </td>
                <td width="150" bgcolor="white"><input type="number" name="Inlet_Temp"></td>
            </tr>
            <tr align="center" height="50"> 
                <td width="150" bgcolor="grey"> Spray_Rate </td>
                <td width="150" bgcolor="white"><input type="number" name="Spray_Rate"></td>
            </tr>
            <tr align="center" height="50"> 
                <td width="150" bgcolor="grey"> Dissolution </td>
                <td width="150" bgcolor="white"><input type="number" name="Dissolution"></td>
            <tr>
                <td></td><td width="150" bgcolor="purple"></td><td width="150" bgcolor="purple">
                    <button id="create-button" onclick="doCreate()">CREATE</button>     
                    <button id="update-button" onclick="doUpdate()">UPDATE</button>
                </td>
            </tr>
         </table>
    </div>

    <div id="display">
        <h1> Batches </h1>
        <button onClick="showCreate()">Create</button>
        <table border="7" cellpadding="7" cellspacing="2" align="center" bgcolor="purple" id="batchTable" class="table">
            <tr bgcolor="gray">
                <th> Batch_No </th>
                <th> API_Lot_No </th>
                <th> API_Particle_Size </th>
                <th> Screen_Size </th>
                <th> Blend_Time </th>
                <th> Compressor </th>
                <th> Inlet_Temp </th>
                <th> Spray_Rate </th>
                <th> Dissolution </th>
            </tr>
        </table>
    </div>

    <script>
        function showCreate(){
            document.getElementById('display').style.display = "none"
            document.getElementById('update-button').style.display = "none"
            document.getElementById('create-button').style.display = "block"
            document.getElementById('create-update').style.display = "block"

        }
        function showUpdate(thisElem){
            var rowElement = thisElem.parentNode.parentNode;
            batch = readBatchFromRow(rowElement)
            populateForm(batch)

            document.getElementById('display').style.display = "none"
            document.getElementById('update-button').style.display = "block"
            document.getElementById('create-button').style.display = "none"
            document.getElementById('create-update').style.display = "block"

        }
        function readBatchFromRow(rowElement){
            batch = {}
            batch.Batch_No = rowElement.getAttribute("id");
            batch.API_Lot_No = rowElement.cells[1].firstChild.textContent
            batch.API_Particle_Size = rowElement.cells[2].firstChild.textContent
            batch.Screen_Size = rowElement.cells[3].firstChild.textContent
            batch.Blend_Time = rowElement.cells[4].firstChild.textContent
            batch.Compressor = rowElement.cells[5].firstChild.textContent
            batch.Inlet_Temp = rowElement.cells[6].firstChild.textContent
            batch.Spray_Rate = rowElement.cells[7].firstChild.textContent
            batch.Dissolution = rowElement.cells[8].firstChild.textContent
            return batch
            
        }
        function populateForm(batch){
            var form = document.getElementById('createUpdateForm')

            
            form.querySelector('input[name="Batch_No"]').value = batch.Batch_No
            form.querySelector('input[name="Batch_No"]').disabled=true
            
            form.querySelector('input[name="API_Lot_No"]').value = batch.API_Lot_No
            form.querySelector('input[name="API_Particle_Size"]').value = batch.API_Particle_Size
            form.querySelector('input[name="Screen_Size"]').value = batch.Screen_Size  
            form.querySelector('input[name="Blend_Time"]').value = batch.Blend_Time
            form.querySelector('input[name="Compressor"]').value = batch.Compressor
            form.querySelector('input[name="Inlet_Temp"]').value = batch.Inlet_Temp 
            form.querySelector('input[name="Spray_Rate"]').value = batch.Spray_Rate
            form.querySelector('input[name="Dissolution"]').value = batch.Dissolution
        }
        function clearForm() {
            var form = document.getElementById('createUpdateForm')

            form.querySelector('input[name="Batch_No"]').value = ''
            form.querySelector('input[name="Batch_No"]').disabled = false

            form.querySelector('input[name="API_Lot_No"]').value = ''
            form.querySelector('input[name="API_Particle_Size"]').value = ''
            form.querySelector('input[name="Screen_Size"]').value = ''
            form.querySelector('input[name="Blend_Time"]').value = ''
            form.querySelector('input[name="Compressor"]').value = ''
            form.querySelector('input[name="Inlet_Temp"]').value = ''
            form.querySelector('input[name="Spray_Rate"]').value = ''
            form.querySelector('input[name="Dissolution"]').value = ''
            }


        function doCreate(){
            console.log("doCreate")
            batch= getBatchFromForm()
            console.log(batch)
            $.ajax({
                url:"/tablets",
                data:JSON.stringify(batch),
                methods:"POST",
                dataType:"JSON",
                contentType: "application/json; charset=utf-8",
                success:function(result){
                    console.log(result) 
                    addBatchToTable(batch)
                    showDisplay()
                    clearForm()
                },
                error:function(xhr,status,error){
                    console.log("error"+error)
                }
            })
           
        }
        function doUpdate(){
            batch = getBatchFromForm()
            updateServer(batch)
            
        }
        function updateServer(batch){
           $.ajax({
                url: "/tablets/"+batch.Batch_No, 
                data: JSON.stringify(batch),
                method: "PUT",
                dataType: "JSON",
                contentType: "application/json; charset=utf-8",
                success: function (result) {
                    console.log(result)
                    updateTableRow(batch)
                    showDisplay()
                    clearForm()

                },
                error: function (xhr, status, error) {
                    console.log("error" + error)
                }
            })
        }
        function doDelete(thisElem){
            var tableElement = document.getElementById('batchTable');
            var rowElement = thisElem.parentNode.parentNode;
            var index = rowElement.rowIndex;
            ISBN = rowElement.getAttribute("id");
            $.ajax({
                url:"/tablets/"+Batch_No,
                method:"DELETE",
                dateType:"JSON",
                success:function(result){
                    tableElement.deleteRow(index);
                },
                error:function(xhr,status,error){
                    console.log(error)
                }
            })
            
        }

      
        function updateTableRow(batch){
            rowElement = document.getElementById(batch.Batch_No)
            rowElement.cells[1].firstChild.textContent = batch.API_Lot_No
            rowElement.cells[2].firstChild.textContent = batch.API_Particle_Size
            rowElement.cells[3].firstChild.textContent = batch.Screen_Size
            rowElement.cells[4].firstChild.textContent = batch.Blend_Time
            rowElement.cells[5].firstChild.textContent = batch.Compressor
            rowElement.cells[6].firstChild.textContent = batch.Inlet_Temp
            rowElement.cells[7].firstChild.textContent = batch.Spray_Rate
            rowElement.cells[8].firstChild.textContent = batch.Dissolution
            //console.log("updating table")
        }

        function getBatchFromForm(){
            var form = document.getElementById('createUpdateForm')

            var batch = {}
            batch.Batch_No = form.querySelector('input[name="Batch_No"]').value
            batch.API_Lot_No = form.querySelector('input[name="API_Lot_No"]').value
            batch.API_Particle_Size = form.querySelector('input[name="API_Particle_Size"]').value
            batch.Screen_Size = form.querySelector('input[name="Screen_Size"]').value
            batch.Blend_Time = form.querySelector('input[name="Blend_Time"]').value
            batch.Compressor = form.querySelector('input[name="Compressor"]').value
            batch.Inlet_Temp = form.querySelector('input[name="Inlet_Temp"]').value
            batch.Spray_Rate = form.querySelector('input[name="Spray_Rate"]').value
            batch.Dissolution = form.querySelector('input[name="Dissolution"]').value
            console.log(batch)
             return batch
        }
         function showDisplay() {
                document.getElementById('display').style.display = "block"
                document.getElementById('create-update').style.display = "none"

            }

        function populateTable(){
            //ajax getAll
           $.ajax({
               url:'http://127.0.0.1:5000/tablets',
               method:'GET',
               datatype:'JSON',
               success:function(results){
                    for (batch of results){
                         addBatchToTable(batch)
                    }
               },
               error:function (xhr,status,error){
                   console.log ("error "+error +" code:"+status)
               }

           })
        }
        function addBatchToTable(batch){
            //console.log("working so far")
            tableElem = document.getElementById("batchTable")
            rowElem = tableElem.insertRow(-1)
            rowElem.setAttribute("id", batch.Batch_No)
            cell1 = rowElem.insertCell(0)
            cell1.innerHTML = batch.Batch_No
            cell2 = rowElem.insertCell(1)
            cell2.innerHTML = batch.API_Lot_No
            cell3 = rowElem.insertCell(2)
            cell3.innerHTML = batch.API_Particle_Size
            cell4 = rowElem.insertCell(3)
            cell4.innerHTML = batch.Screen_Size
            cell5 = rowElem.insertCell(4)
            cell5.innerHTML = batch.Blend_Time
            cell6 = rowElem.insertCell(5)
            cell6.innerHTML = batch.Compressor
            cell7 = rowElem.insertCell(6)
            cell7.innerHTML = batch.Inlet_Temp
            cell8 = rowElem.insertCell(7)
            cell8.innerHTML = batch.Spray_Rate
            cell9 = rowElem.insertCell(8)
            cell9.innerHTML = batch.Dissolution
            cell10 = rowElem.insertCell(9)
            cell10.innerHTML = '<button onclick="showUpdate(this)">Update</button>'
            cell11 = rowElem.insertCell(10)
            cell11.innerHTML = '<button onclick="doDelete(this)">delete</button>'
             }
        populateTable()
    </script>
    
</body>

</html>
