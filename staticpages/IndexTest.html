<!DOCTYPE html>

<html>

<head>
    <title> Index </title>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
            
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
                    integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">


</head>

<body>

</div>
    <div id="createUpdateForm" style="display:none" >
        <h1> Create and Update</h1>

        <table  id="createUpdateForm">    
            <tr> 
                <td> Batch_No </td>
                <td><input type="text" name="Batch_No" ></td> 
            </tr> 
            <tr> 
                <td> API_Lot_No </td>
                <td><input type="text" name="API_Lot_No"></td>
            </tr>
            <tr> 
                <td> API_Particle_Size </td>
                <td><input type="text" name="API_Particle_Size"></td>
            </tr>
            <tr> 
                <td> Screen_Size </td>
                <td><input type="text" name="Screen_Size"></td>
            </tr>
            <tr> 
                <td> Blend_Time </td>
                <td><input type="text" name="Blend_Time "></td>
            </tr>
            <tr> 
                <td> Compressor </td>
                <td><input type="text" name="Compressor"></td>
            </tr>
            <tr> 
                <td> Inlet_Temp </td>
                <td><input type="text" name="Inlet_Temp"></td>
            </tr>
            <tr> 
                <td> Spray_Rate </td>
                <td><input type="text" name="Spray_Rate"></td>
            </tr>
            <tr> 
                <td> Dissolution </td>
                <td><input type="text" name="Dissolution"></td>
            <tr>
                <td></td><td>
                    <button id="create-button" onclick="doCreate()">CREATE</button>   //issue??  
                    <button id="update-button" onclick="doUpdate()">UPDATE</button>
                </td>
            </tr>
         </table>
    </div>

    <div id="display">
        <h1> Batches </h1>
        <button id="showCreateButton" onClick="showCreate()">Create</button>
        <table id="tabprdnTable" class="table">
            <tr>
                <th> Batch_No </th>
                <th> API_Lot_No </th>
                <th> API_Particle_Size </th>
                <th> Screen_Size </th>
                <th> Blend_Time </th>
                <th> Compressor </th>
                <th> Inlet_Temp </th>
                <th> Spray_Rate </th>
                <th> Dissolution </th>
                <th></th>
                <th></th>
            </tr>
            <tr id=123>
                <td>123</td>
                <td>AB</td>
                <td>Large</td>
                <td>5</td>
                <td>89</td>
                <td>Compress1</td>
                <td>103</td>
                <td>400</td>
                <td>75</td>
            </tr>
            <tr id=500>
                <td>500</td>
                <td>AC</td>
                <td>Small</td>
                <td>3</td>
                <td>189</td>
                <td>Compress2</td>
                <td>153</td>
                <td>600</td>
                <td>70</td>
            </tr>
        </table>
    </div>

    <script>
        function showCreate(){
            document.getElementById('display').style.display = "none"
            document.getElementById('update-button').style.display = "none"
            document.getElementById('create-button').style.display = "block"
            document.getElementById('createUpdateForm').style.display = "block"

        }

        function showUpdate(thisElem){
            var rowElement = thisElem.parentNode.parentNode;
            tabprdn = readtabprdnFromRow(rowElement)
            populateForm(tabprdn)

            document.getElementById('display').style.display = "none"
            document.getElementById('update-button').style.display = "block"
            document.getElementById('create-button').style.display = "none"
            document.getElementById('createUpdateForm').style.display = "block"
            document.getElementById('doCreateButton').style.display="none"
        }


        function readtabprdnFromRow(rowElement){
            tabprdn = {}
            tabprdn.Batch_No = rowElement.getAttribute("id");
            tabprdn.API_Lot_No = rowElement.cells[1].firstChild.textContent
            tabprdn.API_Particle_Size = rowElement.cells[2].firstChild.textContent
            tabprdn.Screen_Size = rowElement.cells[3].firstChild.textContent
            tabprdn.Blend_Time = rowElement.cells[4].firstChild.textContent
            tabprdn.Compressor = rowElement.cells[5].firstChild.textContent
            tabprdn.Inlet_Temp = rowElement.cells[6].firstChild.textContent
            tabprdn.Spray_Rate = rowElement.cells[7].firstChild.textContent
            tabprdn.Dissolution = rowElement.cells[8].firstChild.textContent
            return tabprdn
            
        }

        function populateForm(tabprdn){
            var form = document.getElementById('createUpdateForm')          
            //form.querySelector('input[name="Batch_No"]').value = tabprdn.Batch_No
            form.querySelector('input[name="Batch_No"]').disabled=true
            
            form.querySelector('input[name="API_Lot_No"]').value = tabprdn.API_Lot_No
            form.querySelector('input[name="API_Particle_Size"]').value = tabprdn.API_Particle_Size
            form.querySelector('input[name="Screen_Size"]').value = tabprdn.Screen_Size  
            form.querySelector('input[name="Blend_Time"]').value = tabprdn.Blend_Time
            form.querySelector('input[name="Compressor"]').value = tabprdn.Compressor
            form.querySelector('input[name="Inlet_Temp"]').value = tabprdn.Inlet_Temp 
            form.querySelector('input[name="Spray_Rate"]').value = tabprdn.Spray_Rate
            form.querySelector('input[name="Dissolution"]').value = tabprdn.Dissolution
            return tabprdn
            }

        function clearForm() {
            var form = document.getElementById('createUpdateForm')

            form.querySelector('input[name="Batch_No"]').value = ''
            form.querySelector('input[name="Batch_No"]').disabled = false

            form.querySelector('input[name="API_Lot_No"]').value = ''
            form.querySelector('input[name="API_Particle_Size"]').value = ''
            form.querySelector('input[name="Screen_Size"]').value = ''
            form.querySelector('input[name="Blend_Time"]').value = ''
            form.querySelector('input[name="Compressor"]').value = ''
            form.querySelector('input[name="Inlet_Temp"]').value = ''
            form.querySelector('input[name="Spray_Rate"]').value = ''
            form.querySelector('input[name="Dissolution"]').value = ''
            }





        function doCreate(){
            //var tabprdn = {"API_Lot_No" : "AB", "API_Particle_Size":"Large", "Screen_Size":"5", "Blend_Time":89, "Compressor":"Compress1", "Inlet_Temp":110, "Spray_Rate":400, "Dissolution":75}

            tabprdn = gettabprdnFromForm(); //issue here???seems to be here!!!
            console.log(JSON.stringify(tabprdn));
            $.ajax({
                "url":"http://127.0.0.1:5000/tablets",
                "data":JSON.stringify(tabprdn),
                "method":"POST",
                "dataType":"JSON",
                contentType: "application/json; charset=utf-8",
                "success":function(result){
                    console.log(result); 
                    document.getElementById("output").innertext = json.stringify(result);//ensure correct above!!
                    addtabprdnToTable(tabprdn);
                    showDisplay();
                    clearForm();
                },
                error:function(xhr,status,error){
                    console.log("error"+error)
                }
            });           
        }

        function doUpdate(){
            tabprdn = gettabprdnFromForm()
            updateServer(tabprdn)            
        }

        function updateServer(tabprdn){
           $.ajax({
                url: "/tablets/"+encodeURL(tabprdn.Batch_No), 
                data: JSON.stringify(tabprdn),
                method: "PUT",
                dataType: "JSON",
                contentType: "application/json; charset=utf-8",
                success: function (result) {
                    console.log(result)
                    updateTableRow(tabprdn)
                    showDisplay()
                    clearForm()

                },
                error: function (xhr, status, error) {
                    console.log("error" + error)
                }
            });
        }

        function doDelete(thisElem){
            var tableElement = document.getElementById('tabprdnTable');
            var rowElement = thisElem.parentNode.parentNode;
            var index = rowElement.rowIndex;
            ISBN = rowElement.getAttribute("id");
            $.ajax({
                url:"/tablets/"+encodeURL(tabprdn.Batch_No),
                method:"DELETE",
                dateType:"JSON",
                success:function(result){
                    tableElement.deleteRow(index);
                },
                error:function(xhr,status,error){
                    console.log(error)
                }
            });
        }
      
        function updateTableRow(tabprdn){
            rowElement = document.getElementById(tabprdn.Batch_No)
            rowElement.cells[1].firstChild.textContent = tabprdn.API_Lot_No
            rowElement.cells[2].firstChild.textContent = tabprdn.API_Particle_Size
            rowElement.cells[3].firstChild.textContent = tabprdn.Screen_Size
            rowElement.cells[4].firstChild.textContent = tabprdn.Blend_Time
            rowElement.cells[5].firstChild.textContent = tabprdn.Compressor
            rowElement.cells[6].firstChild.textContent = tabprdn.Inlet_Temp
            rowElement.cells[7].firstChild.textContent = tabprdn.Spray_Rate
            rowElement.cells[8].firstChild.textContent = tabprdn.Dissolution
            //console.log("updating table")
        }



        function gettabprdnFromForm(){ //issues from here
            var form = document.getElementById('createUpdateForm')

            var tabprdn = {}
            tabprdn.Batch_No = form.querySelector('input[name="Batch_No"]').value
            tabprdn.API_Lot_No = form.querySelector('input[name="API_Lot_No"]').value
            tabprdn.API_Particle_Size = form.querySelector('input[name="API_Particle_Size"]').value
            tabprdn.Screen_Size = form.querySelector('input[name="Screen_Size"]').value
            tabprdn.Blend_Time = form.querySelector('input[name="Blend_Time"]').textContent //issue here???
            tabprdn.Compressor = form.querySelector('input[name="Compressor"]').value
            tabprdn.Inlet_Temp = form.querySelector('input[name="Inlet_Temp"]').value
            tabprdn.Spray_Rate = form.querySelector('input[name="Spray_Rate"]').value
            tabprdn.Dissolution = form.querySelector('input[name="Dissolution"]').value
            //console.log(tabprdn)
            return tabprdn
        }
         function showDisplay() {
                document.getElementById('display').style.display = "block"
                document.getElementById('createUpdateForm').style.display = "none"

            }

        function populateTable(){
            //ajax getAll
           $.ajax({
               url:'http://127.0.0.1:5000/tablets',
               method:'GET',
               data:"",
               dataType:'JSON',
               success:function(result){
                    for (tabprdn of result){
                         addtabprdnToTable(tabprdn)
                    }
               },
               error:function (xhr,status,error){
                   console.log ("error "+error +" code:"+status)
               }

           });
        }
        function addtabprdnToTable(tabprdn){
            tableElem = document.getElementById("tabprdnTable")
            rowElem = tableElem.insertRow(-1)
            rowElem.setAttribute("id", tabprdn.Batch_No)
            cell1 = rowElem.insertCell(0)
            cell1.innerHTML = tabprdn.Batch_No
            cell2 = rowElem.insertCell(1)
            cell2.innerHTML = tabprdn.API_Lot_No
            cell3 = rowElem.insertCell(2)
            cell3.innerHTML = tabprdn.API_Particle_Size
            cell4 = rowElem.insertCell(3)
            cell4.innerHTML = tabprdn.Screen_Size
            cell5 = rowElem.insertCell(4)
            cell5.innerHTML = tabprdn.Blend_Time
            cell6 = rowElem.insertCell(5)
            cell6.innerHTML = tabprdn.Compressor
            cell7 = rowElem.insertCell(6)
            cell7.innerHTML = tabprdn.Inlet_Temp
            cell8 = rowElem.insertCell(7)
            cell8.innerHTML = tabprdn.Spray_Rate
            cell9 = rowElem.insertCell(8)
            cell9.innerHTML = tabprdn.Dissolution
            cell10 = rowElem.insertCell(9)
            cell10.innerHTML = '<button onclick="showUpdate(this)">Update</button>'
            cell11 = rowElem.insertCell(10)
            cell11.innerHTML = '<button onclick="doDelete(this)">delete</button>'
             }
        populateTable()
    </script>
    
</body>

</html>
